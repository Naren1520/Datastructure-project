<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexStock - Split Screen Code Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #131313 0%, #764ba2 100%);
            padding: 15px 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            border: 2px solid white;
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-title h1 {
            font-size: 1.5em;
            margin: 0;
        }

        .header-title p {
            font-size: 0.9em;
            opacity: 0.9;
            margin: 0;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .about-developer-btn {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .workflow-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }

        /* Tab System for Code Logic and Flow Diagram */
        .right-panel-header {
            background: #1a1a1a;
            padding: 12px 15px;
            border-bottom: 2px solid #444;
            display: flex;
            gap: 0;
            align-items: center;
        }

        .panel-tabs {
            display: flex;
            gap: 0;
            flex: 1;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #2a2a2a;
            border: none;
            color: #888;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #66cbea;
        }

        .tab-btn.active {
            color: #66cbea;
            border-bottom-color: #66cbea;
            background: #1a1a1a;
        }

        #diagramPanel {
            display: none;
        }

        #diagramPanel.active {
            display: flex;
        }

        #codePanel.hidden {
            display: none;
        }

        #flowDiagramContent {
            padding: 20px;
            text-align: center;
            color: #888;
            flex: 1;
            overflow-y: auto;
        }

        .diagram-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            object-fit: contain;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
            gap: 0;
        }

        .split-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 3px solid #444;
            overflow: hidden;
        }

        .split-panel:last-child {
            border-right: none;
        }

        .panel-header {
            background: #1a1a1a;
            padding: 12px 15px;
            border-bottom: 2px solid #444;
            font-weight: 600;
            font-size: 0.95em;
            color: #66cbea;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Left Panel - Frontend UI */
        .left-panel .panel-content {
            background: #f5f5f5;
            color: #333;
        }

        .ui-frame {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 15px;
        }

        .ui-frame h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.85em;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f5f5f5;
        }

        /* Right Panel - C Code */
        .right-panel .panel-content {
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            padding: 0;
        }

        .code-block {
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 5px;
            margin: 15px;
            overflow: hidden;
        }

        .code-header {
            background: #2a2a2a;
            padding: 10px 15px;
            border-bottom: 1px solid #444;
            font-weight: 600;
            color: #66cbea;
            font-size: 0.9em;
        }

        .code-content {
            padding: 12px 15px;
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;
            max-height: none;
        }

        pre {
            margin: 0;
            color: #e0e0e0;
            font-size: 0.85em;
            line-height: 1.5;
        }

        /* Syntax Highlighting */
        .keyword { color: #66d9ef; font-weight: 600; }
        .type { color: #a1efe4; }
        .function { color: #a6e22e; }
        .string { color: #e6db74; }
        .comment { color: #75715e; }
        .number { color: #ae81ff; }
        .operator { color: #f92672; }

        .interactive-demo {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .interactive-demo h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .action-log {
            background: #1a1a1a;
            color: #66cbea;
            padding: 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #888;
            margin-right: 10px;
            min-width: 50px;
        }

        .log-action {
            flex: 1;
            color: #66d9ef;
        }

        .log-status {
            color: #a6e22e;
        }

        /* Code highlighting */
        .code-line {
            padding: 2px 0;
            position: relative;
        }

        .code-line.highlight-active {
            background: rgba(166, 226, 46, 0.2);
            border-left: 3px solid #a6e22e;
            padding-left: 10px;
            font-weight: 600;
        }

        .code-line.highlight-completed {
            background: rgba(102, 217, 239, 0.1);
            border-left: 3px solid #66d9ef;
            padding-left: 10px;
        }

        .execution-step {
            display: inline-block;
            background: #a6e22e;
            color: #1a1a1a;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 10px;
            font-weight: 700;
        }

        .execution-comment {
            display: inline-block;
            background: rgba(102, 217, 239, 0.3);
            color: #66cbea;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 10px;
            font-style: italic;
        }

        /* Scrollbar styling */
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: calc(100vh - 120px);
            }

            .split-panel {
                border-right: none;
                border-bottom: 3px solid #444;
                height: 50%;
            }

            .split-panel:last-child {
                border-right: none;
                border-bottom: none;
            }

            .code-content {
                max-height: 200px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2em;
            }

            .container {
                height: calc(100vh - 50px);
            }

            .code-content {
                font-size: 0.75em;
                max-height: 150px;
            }

            table {
                font-size: 0.75em;
            }
        }

        .empty-log {
            color: #888;
            text-align: center;
            padding: 20px;
        }

        #productsTableContainer {
            display: none;
        }

        #productsTableContainer.show {
            display: block;
        }

        .highlight {
            background: rgba(102, 203, 234, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            border-left: 3px solid #66cbea;
            padding-left: 8px;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <img src="./assests/logo.png" alt="NexStock Logo">
            </div>
            <div class="header-title">
                <h1>NexStock</h1>
                <p>Code-Logic Viewer</p>
            </div>
        </div>
        <div class="header-right">
            <a href="documentation.html" class="back-btn">Documentation</a>
            <a href="about-me.html" class="back-btn about-developer-btn">About Developer</a>
            <button class="back-btn" onclick="goBack()">Back to Main</button>
        </div>
    </div>

    <div class="container">
        <!-- Left Panel: Frontend UI -->
        <div class="split-panel left-panel">
            <div class="panel-header">Frontend- User Interactions</div>
            <div class="panel-content">
                <!-- Add Product Demo -->
                <div class="ui-frame">
                    <h3>Add Product to Inventory</h3>
                    <div class="form-group">
                        <label for="productId">Product ID</label>
                        <input type="number" id="productId" placeholder="Enter product ID" value="101">
                    </div>
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" placeholder="Enter product name" value="Laptop">
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price (₹)</label>
                        <input type="number" id="productPrice" placeholder="Enter price" step="0.01" value="45000">
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Quantity</label>
                        <input type="number" id="productQuantity" placeholder="Enter quantity" value="10">
                    </div>
                    <button class="btn" onclick="demonstrateAddProduct()">Add Product</button>
                    <div id="addProductMessage"></div>
                </div>

                <!-- View Products Demo -->
                <div class="ui-frame">
                    <h3>View All Products</h3>
                    <button class="btn" onclick="demonstrateViewProducts()">Load Products</button>
                    <div class="table-container" id="productsTableContainer">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Search Product Demo -->
                <div class="ui-frame">
                    <h3>Search Product by ID</h3>
                    <div class="form-group">
                        <label for="searchId">Search ID</label>
                        <input type="number" id="searchId" placeholder="Enter product ID to search" value="101">
                    </div>
                    <button class="btn" onclick="demonstrateSearch()">Search</button>
                    <div id="searchMessage"></div>
                </div>

                <!-- Delete Product Demo -->
                <div class="ui-frame">
                    <h3>Delete Product</h3>
                    <div class="form-group">
                        <label for="deleteId">Product ID to Delete</label>
                        <input type="number" id="deleteId" placeholder="Enter product ID" value="101">
                    </div>
                    <button class="btn" onclick="demonstrateDelete()">Delete Product</button>
                    <div id="deleteMessage"></div>
                </div>

                <!-- Sort Products Demo -->
                <div class="ui-frame">
                    <h3>Sort Products</h3>
                    <button class="btn" onclick="demonstrateSort()">Sort by ID</button>
                    <div id="sortMessage"></div>
                </div>

                <!-- Update Product Demo -->
                <div class="ui-frame">
                    <h3>Update Product Details</h3>
                    <div class="form-group">
                        <label for="updateId">Product ID</label>
                        <input type="number" id="updateId" placeholder="Enter product ID" value="102">
                    </div>
                    <div class="form-group">
                        <label for="updatePrice">New Price (₹)</label>
                        <input type="number" id="updatePrice" placeholder="Enter new price" step="0.01" value="550">
                    </div>
                    <div class="form-group">
                        <label for="updateQuantity">New Quantity</label>
                        <input type="number" id="updateQuantity" placeholder="Enter new quantity" value="75">
                    </div>
                    <button class="btn" onclick="demonstrateUpdate()">Update Product</button>
                    <div id="updateMessage"></div>
                </div>

                <!-- Record Rental Demo -->
                <div class="ui-frame">
                    <h3>Record Product Rental</h3>
                    <div class="form-group">
                        <label for="rentalId">Rental ID</label>
                        <input type="number" id="rentalId" placeholder="Enter rental ID" value="1001">
                    </div>
                    <div class="form-group">
                        <label for="rentalProductId">Product ID</label>
                        <input type="number" id="rentalProductId" placeholder="Enter product ID" value="103">
                    </div>
                    <div class="form-group">
                        <label for="renterName">Renter Name</label>
                        <input type="text" id="renterName" placeholder="Enter renter name" value="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="rentalAmount">Amount (₹)</label>
                        <input type="number" id="rentalAmount" placeholder="Enter rental amount" step="0.01" value="500">
                    </div>
                    <button class="btn" onclick="demonstrateRental()">Record Rental</button>
                    <div id="rentalMessage"></div>
                </div>

                <!-- Action Log -->
                <div class="interactive-demo">
                    <h4>Action Log</h4>
                    <div class="action-log" id="actionLog">
                        <div class="empty-log">
                            Actions will appear here...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: C Code -->
        <div class="split-panel right-panel">
            <div class="right-panel-header">
                <div class="panel-tabs">
                    <button class="tab-btn active" id="codeTab" onclick="switchTab('code')">Backend Logic</button>
                    <button class="tab-btn" id="diagramTab" onclick="switchTab('diagram')">Project Flow</button>
                    <button class="tab-btn" id="fullCodeTab" onclick="openFullCCode()">Code</button>
                </div>
            </div>
            <div class="panel-content" id="codePanel">
                <div class="code-block" id="activeCodeBlock">
                    <div class="code-header">Select an action from the left panel to see the C code...</div>
                    <div class="code-content">
                        <pre>// Click buttons on the left to see the corresponding C code here</pre>
                    </div>
                </div>
            </div>
            <div class="panel-content" id="diagramPanel">
                <!-- Workflow Diagram loaded from separate page -->
                <iframe id="workflowDiagramIframe" src="./workflow-diagram.html" class="workflow-iframe"></iframe>
            </div>
        </div>
    </div>

    <script>
        // Tab switching function
        function switchTab(tabName) {
            const codePanel = document.getElementById('codePanel');
            const diagramPanel = document.getElementById('diagramPanel');
            const codeTab = document.getElementById('codeTab');
            const diagramTab = document.getElementById('diagramTab');
            const fullCodeTab = document.getElementById('fullCodeTab');

            if (tabName === 'code') {
                codePanel.classList.remove('hidden');
                diagramPanel.classList.remove('active');
                codeTab.classList.add('active');
                diagramTab.classList.remove('active');
                fullCodeTab.classList.remove('active');
            } else if (tabName === 'diagram') {
                codePanel.classList.add('hidden');
                diagramPanel.classList.add('active');
                codeTab.classList.remove('active');
                diagramTab.classList.add('active');
                fullCodeTab.classList.remove('active');
            }
        }

        // Open complete C code page
        function openFullCCode() {
            window.location.href = './c-code.html';
        }

        // No embedded workflow functions - using iframe instead
        function openWorkflowDiagram() {
            switchTab('diagram');
        }

        function renderWorkflowStep(operationId) {
            // Workflow diagram is now displayed via iframe
            // No embedded rendering needed
        }

        // Back button function
        function goBack() {
            window.location.href = '/main.html';
        }

        // Set flow diagram image (user will provide image)
        function setFlowDiagramImage(imagePath) {
            const content = document.getElementById('flowDiagramContent');
            content.innerHTML = `<img src="${imagePath}" alt="Project Flow Diagram" class="diagram-image">`;
        }

        // Execution map: tracks which lines execute for each operation
        const executionMap = {
            addProduct: {
                id_input: { lines: [18], step: 'Read ID', comment: 'Receive ID from frontend' },
                name_input: { lines: [21], step: 'Read Name', comment: 'Receive product name' },
                price_input: { lines: [22], step: 'Read Price', comment: 'Receive price' },
                qty_input: { lines: [23], step: 'Read Qty', comment: 'Receive quantity' },
                duplicate_check: { lines: [26, 27, 28, 29], step: 'Validate', comment: 'Check for duplicate ID' },
                add_to_array: { lines: [35, 36], step: 'Store', comment: 'Add product to array' },
                save_json: { lines: [39], step: 'Persist', comment: 'Save to JSON file' }
            },
            viewProducts: {
                file_open: { lines: [15], step: 'Open File', comment: 'Read inventory.json' },
                json_parse: { lines: [16], step: 'Parse', comment: 'Parse JSON array' },
                loop_extract: { lines: [20, 21, 22, 23, 24, 25], step: 'Loop', comment: 'Extract each product' },
                return_data: { lines: [28], step: 'Return', comment: 'Send product array to frontend' }
            },
            searchProduct: {
                id_input: { lines: [15], step: 'Read ID', comment: 'Receive search ID' },
                loop_search: { lines: [18, 19, 20], step: 'Search', comment: 'Loop through products' },
                found_display: { lines: [22, 23, 24, 25, 26, 27, 28], step: 'Found', comment: 'Display details' },
                not_found: { lines: [32], step: 'Error', comment: 'Product not found' }
            },
            deleteProduct: {
                id_input: { lines: [14], step: 'Read ID', comment: 'Receive delete ID' },
                find_product: { lines: [17, 18, 19, 20, 21], step: 'Find', comment: 'Search for product' },
                shift_array: { lines: [27, 28, 29, 30], step: 'Delete', comment: 'Shift elements left' },
                save_json: { lines: [35], step: 'Persist', comment: 'Update JSON file' }
            },
            sortById: {
                bubble_outer: { lines: [16, 17], step: 'Loop-1', comment: 'Outer loop iterations' },
                bubble_inner: { lines: [19, 20], step: 'Loop-2', comment: 'Inner loop comparison' },
                compare: { lines: [22, 23], step: 'Compare', comment: 'Check if IDs out of order' },
                swap: { lines: [27, 28, 29], step: 'Swap', comment: 'Exchange products' }
            },
            updateProduct: {
                id_input: { lines: [17], step: 'Read ID', comment: 'Receive product ID' },
                find_product: { lines: [20, 21, 22, 23, 24], step: 'Find', comment: 'Search for product' },
                update_price: { lines: [30], step: 'Update', comment: 'Change product price' },
                update_qty: { lines: [33], step: 'Update', comment: 'Change product quantity' },
                save_json: { lines: [36], step: 'Persist', comment: 'Save changes to JSON' }
            },
            recordRental: {
                check_space: { lines: [17, 18, 19, 20], step: 'Check', comment: 'Verify rental space' },
                rental_id_input: { lines: [24], step: 'Read ID', comment: 'Receive rental ID' },
                product_id_input: { lines: [27], step: 'Read ID', comment: 'Receive product ID' },
                verify_product: { lines: [30, 31, 32, 33, 34, 35, 36], step: 'Verify', comment: 'Check if product exists' },
                collect_details: { lines: [41, 42, 45, 46, 49, 50, 53, 54], step: 'Collect', comment: 'Get renter information' },
                store_rental: { lines: [58, 59], step: 'Store', comment: 'Add to rentals array' },
                save_json: { lines: [62], step: 'Persist', comment: 'Save to rentals.json' }
            }
        };

        const cCodeMap = {
            addProduct: {
                name: 'addProduct() - Add Product to Inventory',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Add Product":
// ========================================
// 1. Frontend collects form data (ID, Name, Price, Qty)
// 2. Frontend validates input (checks if empty)
// 3. Frontend sends POST request to: /api/c/product/add
// 4. Server.js receives request and calls:
//    → cBackend.addProduct(id, name, price, quantity)
// 5. This C function is called (shown below)
// ========================================

void addProduct() {
    if (count >= MAX) {
        printf("Inventory full!\\n");
        return;
    }

    struct Product p;
    printf("Enter Product ID: ");
    scanf("%d", &p.id);

    // CHECK: Does this ID already exist?
    for(int i = 0; i < count; i++) {
        if(inventory[i].id == p.id) {
            printf("Product ID %d already exists!\\n", p.id);
            return; // REJECT duplicate
        }
    }

    printf("Enter Product Name: ");
    scanf(" %[^\\n]", p.name);
    printf("Enter Price: ");
    scanf("%f", &p.price);
    printf("Enter Quantity: ");
    scanf("%d", &p.quantity);

    // ADD to array
    inventory[count] = p;
    count++;

    printf("Product added successfully!\\n");
    
    // SAVE to JSON file (persistent storage)
    saveToJSON();
    
    // Return response back to frontend
    // Frontend gets: {success: true, message: "Added"}
    // Frontend shows success message 
}`
            },
            viewProducts: {
                name: 'readInventory() - Load All Products',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Load Products":
// ========================================
// 1. Frontend sends GET request to: /api/c/products
// 2. Server.js receives and calls:
//    → cBackend.readInventory()
// 3. This function reads inventory.json file
// 4. Parses JSON and returns product array
// 5. Server sends back to frontend as JSON
// 6. Frontend populates table with data
// ========================================

// Data in inventory.json looks like:
// [
//   {"id":101, "name":"Laptop", "price":45000, "quantity":10},
//   {"id":102, "name":"Mouse", "price":500, "quantity":50}
// ]

struct InventoryData {
    struct Product *products;
    int count;
};

InventoryData readInventory() {
    FILE *file = fopen("inventory.json", "r");
    if(!file) {
        return (InventoryData){NULL, 0};
    }

    // Parse JSON array
    cJSON *json = cJSON_ParseFile(file);
    fclose(file);

    cJSON *item = NULL;
    int idx = 0;

    // LOOP: Extract each product from JSON
    cJSON_ArrayForEach(item, json) {
        products[idx].id = item->child->valueint;
        strcpy(products[idx].name, 
               item->child->next->valuestring);
        products[idx].price = 
               item->child->next->next->valuedouble;
        products[idx].quantity = 
               item->child->next->next->next->valueint;
        idx++;
    }

    cJSON_Delete(json);
    
    // RETURN: Product array to frontend
    // Frontend receives and displays in table
    return (InventoryData){products, idx};
}`
            },
            searchProduct: {
                name: 'searchProduct() - Find Product by ID',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Search":
// ========================================
// 1. Frontend gets search ID from input field
// 2. Validates that ID is entered
// 3. Sends GET request: /api/c/search?id=<id>
// 4. Server.js extracts ID parameter
// 5. Calls: cBackend.searchProduct(id)
// 6. C function loops through products array
// 7. Finds product with matching ID
// 8. Server sends product details as JSON
// 9. Frontend displays in table
// ========================================

void searchProduct() {
    int searchId;
    // RECEIVE: Search ID from frontend
    printf("Enter Product ID to search: ");
    scanf("%d", &searchId);

    // SEARCH: Loop through product array
    for(int i = 0; i < count; i++) {
        // MATCH CHECK: Is this the product?
        if(inventory[i].id == searchId) {
            // FOUND: Display all details
            printf("\\n=== Product Found ===\\n");
            printf("ID: %d\\n", inventory[i].id);
            printf("Name: %s\\n", inventory[i].name);
            printf("Price: ₹%.2f\\n", inventory[i].price);
            printf("Quantity: %d\\n", inventory[i].quantity);
            printf("Total Value: ₹%.2f\\n", 
                   inventory[i].price * inventory[i].quantity);
            
            // RETURN: Send data to frontend
            // Frontend displays and shows success message
            return;
        }
    }

    // NOT FOUND: Send error response
    printf("Product with ID %d not found!\\n", searchId);
    // Frontend shows: "Product not found" message
}`
            },
            deleteProduct: {
                name: 'deleteProduct() - Remove Product',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Delete":
// ========================================
// 1. Frontend asks for product ID to delete
// 2. User enters ID and confirms
// 3. Sends DELETE request: /api/c/product/<id>
// 4. Server.js receives ID parameter
// 5. Calls: cBackend.deleteProduct(id)
// 6. C function searches for product
// 7. If found: removes from array (shifts elements)
// 8. Saves updated array to JSON
// 9. Server sends success message
// 10. Frontend shows "Deleted!" and reloads table
// ========================================

void deleteProduct() {
    int deleteId;
    // RECEIVE: ID of product to delete
    printf("Enter Product ID to delete: ");
    scanf("%d", &deleteId);

    // SEARCH: Find product position
    int found = -1;
    for(int i = 0; i < count; i++) {
        if(inventory[i].id == deleteId) {
            // MARK: Remember position
            found = i;
            break;
        }
    }

    // CHECK: Was product found?
    if(found == -1) {
        // NOT FOUND: Return error
        printf("Product not found!\\n");
        return;
    }

    // DELETE: Shift all elements left
    // This removes the product from array
    for(int i = found; i < count - 1; i++) {
        inventory[i] = inventory[i + 1];
    }

    // UPDATE: Decrease product count
    count--;
    printf("Product deleted successfully!\\n");
    
    // PERSIST: Update JSON file
    saveToJSON();
    
    // RESPONSE: Send to frontend
    // Frontend updates table view
}`
            },
            sortById: {
                name: 'sortByID() - Sort by Product ID',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Sort by ID":
// ========================================
// 1. Frontend sends GET request: /api/c/sort/id
// 2. Server.js calls: cBackend.sortByID()
// 3. C function uses Bubble Sort algorithm
// 4. Compares each pair of products by ID
// 5. Swaps if needed to put in ascending order
// 6. Returns sorted array to frontend
// 7. Frontend displays products in ID order
// 8. Frontend shows: "Sorted by ID!"
// ========================================

void sortByID() {
    // ALGORITHM: Bubble Sort by ID
    // Multiple passes to sort array
    for(int i = 0; i < count - 1; i++) {
        // INNER LOOP: Compare adjacent elements
        for(int j = 0; j < count - i - 1; j++) {
            // COMPARE: Check if IDs are out of order
            if(inventory[j].id > inventory[j + 1].id) {
                // SWAP: Exchange two products
                // This puts smaller ID first
                struct Product temp = inventory[j];
                inventory[j] = inventory[j + 1];
                inventory[j + 1] = temp;
                
                // Before swap: [..., 105, 101, ...]
                // After swap:  [..., 101, 105, ...]
            }
        }
    }

    // COMPLETE: Array is now sorted by ID
    printf("Products sorted by ID\\n");
    displayProducts();
    
    // SEND: Return sorted array to frontend
    // Frontend table displays: ID 101, 102, 103... ascending
}`
            },
            recordRental: {
                name: 'recordRental() - Add Rental Transaction',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Record Rental":
// ========================================
// 1. Frontend collects rental details from form
// 2. Validates: Rental ID, Product ID, Renter Name, Dates
// 3. Sends POST request: /api/c/rental/add
// 4. Server.js receives rental data
// 5. Calls: cBackend.recordRental(rentalData)
// 6. C function checks if rental array has space
// 7. Verifies product exists in inventory
// 8. Stores rental record with "active" status
// 9. Saves rental to JSON
// 10. Returns confirmation to frontend
// 11. Frontend shows: "Rental recorded!"
// ========================================

void recordRental() {
    // CHECK: Is there space for new rental?
    if(rentalCount >= MAX) {
        printf("Rental records full!\\n");
        return;
    }

    // PREPARE: Create new rental structure
    struct Rental rental;
    
    // RECEIVE: Get rental ID from frontend
    printf("Enter Rental ID: ");
    scanf("%ld", &rental.rentalId);

    // RECEIVE: Get product ID to rent
    printf("Enter Product ID: ");
    scanf("%d", &rental.productId);

    // VERIFY: Check if product exists
    int found = 0;
    for(int i = 0; i < count; i++) {
        if(inventory[i].id == rental.productId) {
            // COPY: Remember product name
            strcpy(rental.productName, inventory[i].name);
            found = 1;
            break;
        }
    }

    // VALIDATION: Product must exist
    if(!found) {
        printf("Product not found!\\n");
        return;
    }

    // RECEIVE: Collect renter details
    printf("Enter Renter Name: ");
    scanf(" %[^\\n]", rental.renterName);

    printf("Enter Rent Date (DD-MM-YYYY): ");
    scanf("%s", rental.rentDate);

    printf("Enter Return Date (DD-MM-YYYY): ");
    scanf("%s", rental.returnDate);

    printf("Enter Phone: ");
    scanf("%s", rental.phoneNumber);

    printf("Enter Amount Paid: ");
    scanf("%f", &rental.amountPaid);

    // SET: Mark rental as active
    strcpy(rental.status, "active");
    
    // STORE: Add to rentals array
    rentals[rentalCount] = rental;
    rentalCount++;

    // PERSIST: Save to rentals.json
    saveToJSON();
    
    // RESPONSE: Confirm to frontend
    printf("Rental recorded successfully!\\n");
    // Frontend shows success message and updates list
}`
            },
            updateProduct: {
                name: 'updateProduct() - Modify Product Details',
                code: `// ========================================
// WHAT HAPPENS WHEN YOU CLICK "Update Product":
// ========================================
// 1. Frontend asks user which product to update
// 2. User enters product ID to modify
// 3. Frontend sends PATCH request: /api/c/product/<id>
// 4. Server.js extracts ID and new values
// 5. Calls: cBackend.updateProduct(id, newPrice, newQty)
// 6. C function searches for product by ID
// 7. If found: updates price and quantity fields
// 8. Saves updated inventory to JSON
// 9. Server sends success response
// 10. Frontend shows: "Product updated!"
// ========================================

void updateProduct() {
    // RECEIVE: Which product to update?
    int updateId;
    printf("Enter Product ID to update: ");
    scanf("%d", &updateId);

    // SEARCH: Find product position
    int found = -1;
    for(int i = 0; i < count; i++) {
        if(inventory[i].id == updateId) {
            found = i;
            break;
        }
    }

    // CHECK: Did we find the product?
    if(found == -1) {
        printf("Product not found!\\n");
        return;
    }

    // UPDATE: Get new price from frontend
    printf("Enter new Price: ");
    scanf("%f", &inventory[found].price);

    // UPDATE: Get new quantity from frontend
    printf("Enter new Quantity: ");
    scanf("%d", &inventory[found].quantity);

    // PERSIST: Save updated data to JSON
    saveToJSON();
    
    // RESPONSE: Confirm update
    printf("Product updated successfully!\\n");
    
    // RETURN: Send updated product to frontend
    // Frontend displays updated values in table
    // Frontend shows timestamp: "Last updated: 3:45 PM"
}`
            },
        };

        let actionLogEntries = [];

        function logAction(action, details, status = 'success') {
            const time = new Date().toLocaleTimeString();
            const entry = { time, action, details, status };
            actionLogEntries.unshift(entry);
            
            if (actionLogEntries.length > 10) {
                actionLogEntries.pop();
            }
            
            updateActionLog();
        }

        function updateActionLog() {
            const logDiv = document.getElementById('actionLog');
            if (actionLogEntries.length === 0) {
                logDiv.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Actions will appear here...</div>';
                return;
            }

            logDiv.innerHTML = actionLogEntries.map(entry => `
                <div class="log-entry">
                    <span class="log-time">${entry.time}</span>
                    <span class="log-action">${entry.action}</span>
                    <span class="log-status">${entry.status}</span>
                </div>
            `).join('');
        }

        let currentCodeKey = null;
        let executedLines = new Set();

        function displayCCode(codeKey, highlightLines = [], executionSteps = []) {
            const codeData = cCodeMap[codeKey];
            if (!codeData) return;

            currentCodeKey = codeKey;
            const codePanel = document.getElementById('codePanel');
            const codeLines = codeData.code.split('\n');

            let htmlContent = '';
            codeLines.forEach((line, index) => {
                const lineNum = index + 1;
                let lineClass = 'code-line';
                let stepMarker = '';

                if (highlightLines.includes(lineNum)) {
                    lineClass += ' highlight-active';
                    const step = executionSteps.find(s => s.lines && s.lines.includes(lineNum));
                    if (step) {
                        stepMarker = ` <span class="execution-step">→ ${step.step}</span>`;
                        stepMarker += ` <span class="execution-comment">// ${step.comment}</span>`;
                    }
                    executedLines.add(lineNum);
                } else if (executedLines.has(lineNum)) {
                    lineClass += ' highlight-completed';
                }

                htmlContent += `<div class="${lineClass}">${escapeHtml(line)}${stepMarker}</div>`;
            });

            codePanel.innerHTML = `
                <div class="code-block">
                    <div class="code-header">${codeData.name}</div>
                    <div class="code-content">
                        <pre>${htmlContent}</pre>
                    </div>
                </div>
            `;
        }

        function highlightExecutionFlow(codeKey, inputField) {
            const execMap = executionMap[codeKey];
            if (!execMap || !execMap[inputField]) return;

            const execution = execMap[inputField];
            displayCCode(codeKey, execution.lines, [execution]);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function demonstrateAddProduct() {
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            const quantity = document.getElementById('productQuantity').value;

            if (!id || !name || !price || !quantity) {
                showMessage('addProductMessage', 'Please fill all fields!', 'error');
                logAction('Add Product', 'Missing fields', 'error');
                return;
            }

            showMessage('addProductMessage', 
                `Product added: ${name} (ID: ${id}) | Price: ₹${price} | Qty: ${quantity}`, 
                'success');
            
            logAction('Add Product', `${name} (ID: ${id})`, 'success');
            
            // Show all execution steps
            const allSteps = Object.values(executionMap.addProduct);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('addProduct', allLines, allSteps);
        }

        function demonstrateViewProducts() {
            const container = document.getElementById('productsTableContainer');
            const tbody = document.getElementById('productsTableBody');

            const sampleProducts = [
                { id: 101, name: 'Laptop', price: 45000, quantity: 10 },
                { id: 102, name: 'Mouse', price: 500, quantity: 50 },
                { id: 103, name: 'Keyboard', price: 1500, quantity: 30 },
                { id: 104, name: 'Monitor', price: 15000, quantity: 8 },
                { id: 105, name: 'Headphones', price: 2000, quantity: 25 }
            ];

            tbody.innerHTML = sampleProducts.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>₹${p.price}</td>
                    <td>${p.quantity}</td>
                    <td>₹${(p.price * p.quantity).toLocaleString()}</td>
                </tr>
            `).join('');

            container.classList.add('show');
            logAction('View Products', `Loaded ${sampleProducts.length} products`, 'success');
            
            // Show all view products execution steps
            const allSteps = Object.values(executionMap.viewProducts);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('viewProducts', allLines, allSteps);
        }

        function demonstrateSearch() {
            const searchId = document.getElementById('searchId').value;
            if (!searchId) {
                showMessage('searchMessage', 'Please enter a product ID!', 'error');
                logAction('Search', 'No ID provided', 'error');
                return;
            }

            const sampleProducts = [
                { id: 101, name: 'Laptop', price: 45000, quantity: 10 },
                { id: 102, name: 'Mouse', price: 500, quantity: 50 },
                { id: 103, name: 'Keyboard', price: 1500, quantity: 30 }
            ];

            const found = sampleProducts.find(p => p.id == searchId);
            
            if (found) {
                showMessage('searchMessage', 
                    `Found: ${found.name} | Price: ₹${found.price} | Qty: ${found.quantity}`, 
                    'success');
                logAction('Search', `Found product ID ${searchId}`, 'success');
            } else {
                showMessage('searchMessage', 
                    `Product with ID ${searchId} not found!`, 
                    'error');
                logAction('Search', `Product ID ${searchId} not found`, 'error');
            }

            // Show all search execution steps
            const allSteps = Object.values(executionMap.searchProduct);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('searchProduct', allLines, allSteps);
        }

        function demonstrateDelete() {
            const deleteId = document.getElementById('deleteId').value;
            if (!deleteId) {
                showMessage('deleteMessage', 'Please enter a product ID!', 'error');
                logAction('Delete', 'No ID provided', 'error');
                return;
            }

            showMessage('deleteMessage', 
                `Product with ID ${deleteId} has been deleted!`, 
                'success');
            logAction('Delete', `Deleted product ID ${deleteId}`, 'success');
            
            // Show all delete execution steps
            const allSteps = Object.values(executionMap.deleteProduct);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('deleteProduct', allLines, allSteps);
        }

        function demonstrateSort() {
            showMessage('sortMessage', 
                `Products sorted by ID in ascending order`, 
                'success');
            logAction('Sort', 'Products sorted by ID', 'success');
            
            // Show all sort execution steps
            const allSteps = Object.values(executionMap.sortById);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('sortById', allLines, allSteps);
        }

        function demonstrateUpdate() {
            const updateId = document.getElementById('updateId').value;
            const updatePrice = document.getElementById('updatePrice').value;
            const updateQuantity = document.getElementById('updateQuantity').value;

            if (!updateId || !updatePrice || !updateQuantity) {
                showMessage('updateMessage', 'Please fill all fields!', 'error');
                logAction('Update', 'Missing fields', 'error');
                return;
            }

            showMessage('updateMessage', 
                `Product ID ${updateId} updated | New Price: ₹${updatePrice} | New Qty: ${updateQuantity}`, 
                'success');
            logAction('Update', `Product ID ${updateId}`, 'success');
            
            // Show all update execution steps
            const allSteps = Object.values(executionMap.updateProduct);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('updateProduct', allLines, allSteps);
        }

        function demonstrateRental() {
            const rentalId = document.getElementById('rentalId').value;
            const rentalProductId = document.getElementById('rentalProductId').value;
            const renterName = document.getElementById('renterName').value;
            const rentalAmount = document.getElementById('rentalAmount').value;

            if (!rentalId || !rentalProductId || !renterName || !rentalAmount) {
                showMessage('rentalMessage', 'Please fill all fields!', 'error');
                logAction('Record Rental', 'Missing fields', 'error');
                return;
            }

            showMessage('rentalMessage', 
                `Rental recorded | ID: ${rentalId} | Renter: ${renterName} | Amount: ₹${rentalAmount}`, 
                'success');
            logAction('Record Rental', `Rental ID ${rentalId} - ${renterName}`, 'success');
            
            // Show all rental recording execution steps
            const allSteps = Object.values(executionMap.recordRental);
            const allLines = allSteps.flatMap(s => s.lines);
            displayCCode('recordRental', allLines, allSteps);
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // Show initial code
        window.addEventListener('load', () => {
            displayCCode('addProduct');
            
            // Add event listeners to form inputs for live code highlighting
            document.getElementById('productId').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('addProduct', 'id_input');
                }
            });

            document.getElementById('productName').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('addProduct', 'name_input');
                }
            });

            document.getElementById('productPrice').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('addProduct', 'price_input');
                }
            });

            document.getElementById('productQuantity').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('addProduct', 'qty_input');
                }
            });

            document.getElementById('searchId').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('searchProduct', 'id_input');
                }
            });

            // Delete Product input tracking
            document.getElementById('deleteId').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('deleteProduct', 'id_input');
                }
            });

            // Sort Products - show all execution steps when clicked
            document.querySelector('button[onclick="demonstrateSort()"]').addEventListener('click', () => {
                const allSteps = Object.values(executionMap.sortById);
                const allLines = allSteps.flatMap(s => s.lines);
                displayCCode('sortById', allLines, allSteps);
            });

            // Update Product input tracking
            document.getElementById('updateId').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('updateProduct', 'id_input');
                }
            });

            document.getElementById('updatePrice').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('updateProduct', 'update_price');
                }
            });

            document.getElementById('updateQuantity').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('updateProduct', 'update_qty');
                }
            });

            // Record Rental input tracking
            document.getElementById('rentalId').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('recordRental', 'rental_id_input');
                }
            });

            document.getElementById('rentalProductId').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('recordRental', 'product_id_input');
                }
            });

            document.getElementById('renterName').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('recordRental', 'collect_details');
                }
            });

            document.getElementById('rentalAmount').addEventListener('input', (e) => {
                if (e.target.value) {
                    highlightExecutionFlow('recordRental', 'collect_details');
                }
            });
        });
    </script>
</body>
</html>
